#!/bin/bash

#=================================================
# GENERIC STARTING
#=================================================
# IMPORT GENERIC HELPERS
#=================================================

source _common.sh
source /usr/share/yunohost/helpers

#=================================================
# MANAGE FAILURE OF THE SCRIPT
#=================================================

ynh_abort_if_errors	# Active trap pour arrêter le script si une erreur est détectée.

#=================================================
# RETRIEVE ARGUMENTS FROM THE MANIFEST
#=================================================

# Retrieve arguments
domain=$YNH_APP_ARG_DOMAIN
path_url=$YNH_APP_ARG_PATH
admin_wordpress=$YNH_APP_ARG_ADMIN
language=$YNH_APP_ARG_LANGUAGE
multisite=$YNH_APP_ARG_MULTISITE
is_public=$YNH_APP_ARG_IS_PUBLIC

app=$YNH_APP_INSTANCE_NAME

#=================================================
# CHECK IF THE APP CAN BE INSTALLED WITH THIS ARGS
#=================================================

CHECK_USER "$admin_wordpress"	# Vérifie la validité de l'user admin
path_url=$(ynh_normalize_url_path $path_url)	# Vérifie et corrige la syntaxe du path.
CHECK_DOMAINPATH	# Vérifie la disponibilité du path et du domaine.
CHECK_FINALPATH	# Vérifie que le dossier de destination n'est pas déjà utilisé.

if [ "$path_url" == "/" ] && [ "$multisite" = "Yes" ]; then
	ynh_die "Multisite option of wordpress doesn't work at root of domain."
fi

#=================================================
# STORE SETTINGS FROM MANIFEST
#=================================================

ynh_app_setting_set $app domain $domain
ynh_app_setting_set $app path $path_url
ynh_app_setting_set $app admin $admin_wordpress
ynh_app_setting_set $app is_public $is_public
ynh_app_setting_set $app language $language
ynh_app_setting_set $app multisite $multisite

#=================================================
# STANDARD MODIFICATIONS
#=================================================
# INSTALL DEPENDENCIES
#=================================================

ynh_install_app_dependencies php5-cli

#=================================================
# CREATE A SQL BDD
#=================================================

db_name=$(ynh_make_valid_dbid $app)
ynh_app_setting_set $app db_name $db_name
ynh_mysql_generate_db $db_name $db_name

#=================================================
# DOWNLOAD, CHECK AND UNPACK SOURCE
#=================================================

ynh_app_setting_set $app final_path $final_path
SETUP_SOURCE	# Télécharge la source, décompresse et copie dans $final_path

#=================================================
# NGINX CONFIGURATION
#=================================================

# Copie le fichier de config nginx
sudo cp ../conf/nginx.conf /etc/nginx/conf.d/$domain.d/$app.conf
# Modifie les variables dans le fichier de configuration nginx
sudo sed -i "s@__PATHTOCHANGE__@$path_url@g" /etc/nginx/conf.d/$domain.d/$app.conf
sudo sed -i "s@__FINALPATH__@$final_path@g" /etc/nginx/conf.d/$domain.d/$app.conf
sudo sed -i "s@__NAMETOCHANGE__@$app@g" /etc/nginx/conf.d/$domain.d/$app.conf

#=================================================
# CREATE DEDICATED USER
#=================================================

ynh_system_user_create $app	# Créer un utilisateur système dédié à l'app

#=================================================
# PHP-FPM CONFIGURATION
#=================================================

POOL_FPM	# Créer le fichier de configuration du pool php-fpm et le configure.

#=================================================
# SPECIFIC SETUP
#=================================================
# CONFIGURE WP-CONFIG
#=================================================

sudo cp ../conf/wp-config.php $final_path/wp-config.php
# Change variables in Wordpress configuration
sudo sed -i "s/__DB_USER__/$db_name/g" $final_path/wp-config.php
sudo sed -i "s/__DB_PWD__/$db_pwd/g" $final_path/wp-config.php
sudo sed -i "s/__DOMAIN__/$domain/g" $final_path/wp-config.php
sudo sed -i "s@__PATH__@$path_url@g" $final_path/wp-config.php

for i in 1 2 3 4 5 6 7 8
do
	j=$(dd if=/dev/urandom bs=1 count=200 2> /dev/null | tr -c -d '[A-Za-z0-9]' | sed -n 's/\(.\{40\}\).*/\1/p')
	if [ "$j" = "" ];
	then
		# For obscure reasons, the loop is too fast at execution
		sleep 1
		j=$(dd if=/dev/urandom bs=1 count=200 2> /dev/null | tr -c -d '[A-Za-z0-9]' | sed -n 's/\(.\{40\}\).*/\1/p')
	fi
	sudo sed -i "s/KEY$i/$j/g" $final_path/wp-config.php
done

#=================================================
# SETTING UP WITH CURL
#=================================================

# Set right permissions for curl install
sudo chown -R $app: $final_path

# Rend la page d'install publique pour curl
ynh_app_setting_set $app unprotected_uris "/"
sudo yunohost app ssowatconf	# Régénère la configuration de SSOwat

# Reload Nginx
sudo systemctl reload nginx

# Wordpress installation
YNH_CURL "&weblog_title=YunoBlog&user_name=$admin_wordpress&admin_password=$db_pwd&admin_password2=$db_pwd&admin_email=$admin_wordpress@$domain&language=$language&Submit=Install+WordPress" "/wp-admin/install.php?step=2"

WARNING echo -n "Please wait during Wordpress installation"
for i in `seq 1 300`
do	# La boucle attend la fin de l'installation de wordpress Ou 5 minutes.
	if ynh_mysql_connect_as $db_name $db_pwd $db_name -e "show tables" | grep -q "wp_options"; then
		break	# Si la table wp_options est trouvée, l'installation de wordpress est terminée. Quitte la boucle.
	fi
	WARNING echo -n "."
	sleep 1
done

#=================================================
# LOAD SQL CONFIG
#=================================================

# Replace variables in sql scripts
sudo sed -i "s@__DOMAIN_PATH__@$domain$path_url@g" ../conf/sql/*.sql
sudo sed -i "s/__LANGUAGE__/$language/g" ../conf/sql/*.sql
sudo sed -i "s/__DATE__/$(date +%s)/g" ../conf/sql/*.sql

# Charge les commandes sql communes à tous les scripts.
# mysql --debug-check -u $db_user -p$db_pwd $db_user < ../conf/sql/common.sql
ynh_mysql_connect_as $db_name $db_pwd $db_name < ../conf/sql/common.sql

#=================================================
# CONFIGURE MULTISITE
#=================================================

if [ $multisite -eq 1 ]
then
	sudo sed -i "s@#--MULTISITE--@@g" /etc/nginx/conf.d/$domain.d/$app.conf
	# Autorise le multisite wordpress
	sudo sed -i "s@//--MULTISITE1--define@define@g" $final_path/wp-config.php

	# Active le multisite via wp-cli.
	sudo wget -nv https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar -O $final_path/wp-cli.phar
	ALL_QUIET php $final_path/wp-cli.phar core multisite-convert --path=$final_path --base=$path_url/

	# Active le multisite wordpress
	sudo sed -i "s@//--MULTISITE2--define@define@g" $final_path/wp-config.php

	# Charge les commandes sql pour activer les plugins
	if [ $is_public -eq 0 ]
	then
		sudo sed -i "s@#--PRIVATE--@@g" ../conf/sql/multisite.sql
	else
		sudo sed -i "s@#--PUBLIC--@@g" ../conf/sql/multisite.sql
	fi
	ynh_mysql_connect_as $db_name $db_pwd $db_name < ../conf/sql/multisite.sql
else
	if [ $is_public -eq 0 ]
	then
		sudo sed -i "s@#--PRIVATE--@@g" /etc/nginx/conf.d/$domain.d/$app.conf
		sudo sed -i "s@#--PRIVATE--@@g" ../conf/sql/single.sql
	else
		sudo sed -i "s@//--PUBLIC--define@define@g" $final_path/wp-config.php
		sudo sed -i "s@#--PRIVATE--@#@g" /etc/nginx/conf.d/$domain.d/$app.conf
		sudo sed -i "s@#--PUBLIC--@@g" ../conf/sql/single.sql
	fi
	# Charge les commandes sql pour activer les plugins
	ynh_mysql_connect_as $db_name $db_pwd $db_name < ../conf/sql/single.sql
fi

# Décommente les add_filter, qui auraient provoqué une erreur avec wp-cli
sudo sed -i "s@//add_filter@add_filter@g" $final_path/wp-config.php

#=================================================
# STORE THE CHECKSUM OF THE CONFIG FILE
#=================================================

STORE_MD5_CONFIG "wp-config.php" "$final_path/wp-config.php"	# Enregistre la somme de contrôle du fichier de config

#=================================================
# GENERIC FINALISATION
#=================================================
# SECURING FILES AND DIRECTORIES
#=================================================

# Les fichiers appartiennent à l'user wordpress, pour permettre les mises à jour.
sudo chown -R $app: $final_path
# Sauf le fichier de config wp-config.php qui appartient à root
sudo chown root: $final_path/wp-config.php

#=================================================
# SETUP SSOWAT
#=================================================

if [ $is_public -eq 0 ];
then
	# Retire l'accès public
	ynh_app_setting_delete $app unprotected_uris
fi

#=================================================
# RELOAD NGINX
#=================================================

sudo systemctl reload nginx

#=================================================
# REMOVE WP-CLI.PHAR
#=================================================

# wp-cli me semble un peu trop permissif... Il a terminé son travail...
sudo rm -f $final_path/wp-cli.phar
